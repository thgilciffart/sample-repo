{
    dynamic_dns {
        provider cloudflare {$CLOUDFLARE_TOKEN}
        domains {
            domain.com @
            domain.com sub
        }
        check_interval 5m
    }

    log {
        output file /var/log/caddy/access.log
        format json
    }
}

(headers) {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        -Server
    }
}

domain.com {
    import headers

    @not_local {
        not remote_ip private_ranges
    }

    handle @not_local {
        ipfilter_geolocation {
            allow_countries AU
            block_by_default true
        }
    }

    handle {
        reverse_proxy IP:PORT
    }

    handle_errors {
    @denied expression {err.status_code} == 403
    respond @denied "Access restricted" 403
    }
}
